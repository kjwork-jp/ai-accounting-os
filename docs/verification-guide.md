# 動作確認手順書

## 前提条件

### 環境変数

```bash
# .env.local (ローカル) / Vercel Environment Variables
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...   # 必須
```

### データベース

Supabase SQL Editor で以下を実行済みであること:
- `supabase/seed.sql` — マスタデータ + 開発テナント
- `supabase/migrations/20260218_add_custom_roles.sql` — カスタムロールテーブル
- `supabase/migrations/20260218_add_entity_name_to_audit_logs.sql` — 監査ログ entity_name カラム

### 起動

```bash
pnpm install
pnpm dev   # http://localhost:3000
# または Vercel デプロイ
```

---

## 1. サインアップ確認

1. `/signup` を開く
2. 氏名・メール・パスワード（8文字以上）を入力
3. 「アカウント登録」をクリック
4. 「アカウントを作成しました」と表示される
5. 「ログインページへ」をクリック

**確認ポイント:**
- メール認証は不要（Admin API で auto-confirm）
- テナントへの自動割当は行われない

---

## 2. ログイン確認

1. `/login` でサインアップしたメール・パスワードを入力
2. テナント未所属の場合 → `/onboarding` にリダイレクト
3. テナント所属済みの場合 → `/dashboard` にリダイレクト

---

## 3. オンボーディング（テナント作成）

1. `/onboarding` が表示される
2. 「組織名（会社名）」に会社名を入力
3. 「テナントを作成して開始」をクリック
4. `/dashboard` にリダイレクトされる
5. サイドバーに全メニューが表示される（admin 権限）

**確認ポイント:**
- テナント作成者は自動的に `admin` ロール
- 一度テナントを作成した後に `/onboarding` へアクセスすると `/dashboard` にリダイレクトされる

---

## 4. ダッシュボード確認

1. ヘッダーに氏名が表示される
2. サイドバーに以下メニューが表示される（admin の場合）:
   - ダッシュボード、証憑管理、仕訳、受注、発注、請求書、決裁、経営分析、取引先、監査ログ、設定
3. クイックアクションカード（6つ）が表示される
4. KPIカード（4つ）が表示される

---

## 5. ユーザー管理確認

1. サイドバー「設定」→「ユーザー管理」タブ
2. 自分のユーザーが一覧に表示される（名前・メール・ロール・ステータス）
3. 「ユーザー追加」ボタン → ダイアログが開く
4. 「...」ボタン → 編集ダイアログ（ベースロール変更、カスタムロール選択、有効/無効化）

**確認ポイント:**
- ユーザー追加時のデフォルトロールは `viewer`（閲覧者）
- 追加するユーザーは先にサインアップ済みである必要がある
- カスタムロールが登録済みの場合、作成/編集ダイアログにカスタムロール選択が表示される

---

## 6. カスタムロール確認

1. サイドバー「設定」→「カスタムロール」タブ
2. 「カスタムロール作成」ボタンをクリック
3. ロール名、ベースロール、追加権限を設定
4. 「作成」をクリック
5. 一覧に作成したカスタムロールが表示される
6. 編集（鉛筆アイコン）・削除（ゴミ箱アイコン）が動作する

**確認ポイント:**
- ベースロールの権限 + 追加権限 が有効権限になる
- 同名のカスタムロールは作成不可（unique 制約）

---

## 7. MFA 設定確認

1. サイドバー「設定」→「セキュリティ」タブ
2. 「MFAを有効にする」ボタンをクリック
3. QRコードが表示される
4. シークレットキーのコピーボタンが動作する
5. （認証アプリがあれば）QRスキャン → 6桁コード入力 → 「二要素認証は有効です」

---

## 8. 監査ログ確認

1. サイドバー「監査ログ」をクリック
2. フィルターパネル（日付・操作・対象）が表示される
3. 操作があれば一覧に表示される:
   - **実行者**: 操作を行ったユーザーの氏名が表示される（`-` ではない）
   - **対象**: エンティティ種別 + 対象の名前が表示される（UUID ではなく氏名など）
   - **変更内容**: 変更前/変更後の差分が JSON で表示される
4. 「検索」「リセット」ボタンが動作する

---

## 9. ファイルアップロード確認

```bash
# curl でテスト（ログイン中のセッションCookieが必要）
curl -X POST http://localhost:3000/api/v1/documents/upload \
  -H "Cookie: <session_cookie>" \
  -F "file=@test.pdf"

# レスポンス: { data: { id, file_name, file_hash_sha256, status: "uploaded", ... } }
```

**確認ポイント:**
- 10MB超のファイルはエラーになる
- 同一ファイル（SHA-256一致）の重複アップロードはエラーになる
- `Idempotency-Key` ヘッダー付きで同じキーを再送信すると既存レコードが返る

---

## 10. ログアウト確認

1. ヘッダー右端のログアウトアイコンをクリック
2. `/login` にリダイレクトされる

---

## 11. ビルド確認

```bash
pnpm build
# エラーなく完了すること
```

---

## S1 チェックリスト

```
□ メール認証でログイン/ログアウトができる
□ TOTP MFAの登録と認証ができる
□ Google OAuthでログインできる
□ 管理者がユーザーを作成/編集/無効化できる
□ 5ロール(admin/accounting/viewer/approver/sales)で画面アクセス制御が動作する
□ カスタムロールの作成/編集/削除/ユーザー割当ができる
□ RLSで他テナントのデータが見えない
□ DashboardLayoutが表示される(サイドバー+ヘッダー)
□ /api/v1/health が {"ok":true} を返す
□ ファイルアップロードでStorage保存+SHA-256記録される
□ 重要操作がaudit_logsに記録される（実行者名・対象名が表示される）
□ pnpm build がエラーなく完了する
□ テナント作成後に /onboarding にアクセスすると /dashboard にリダイレクトされる
```

---

## トラブルシューティング

| 症状 | 原因 | 対処 |
|------|------|------|
| Signup で 500 エラー | `SUPABASE_SERVICE_ROLE_KEY` 未設定 | Vercel / .env.local に設定 |
| ユーザー一覧が空 | DB マイグレーション未実行 or seed 未実行 | Supabase SQL Editor で実行 |
| ログイン後に `/onboarding` に飛ぶ | テナント未作成 | オンボーディングでテナント作成 |
| 「テナント未割当」と表示 | `tenant_users` にレコードがない | オンボーディング or 管理者が追加 |
| カスタムロールタブが 404 | migration 未実行 | `20260218_add_custom_roles.sql` を実行 |
| 監査ログ実行者が `-` | migration 未実行 | `20260218_add_entity_name_to_audit_logs.sql` を実行 |
| 監査ログ実行者が `-` | 旧データ | 新規操作を行うと実行者名が表示される |
| アップロードが失敗 | Storage バケット未作成 | Supabase で `documents` バケットを作成 |
