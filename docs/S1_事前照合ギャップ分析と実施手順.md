# S1事前照合: 現状リポジトリ × 要件/設計 ギャップ分析と今後手順

作成日: 2026-02-17  
対象: `Claude_Code_Document/` 一式（zipはモック資産として参照対象外）

---

## 1. 読み込み完了スコープ（指定順）

以下の順序で、対象ファイルとシート/章を網羅確認した。

1. 要件定義書
   - `要件定義書.docx`（本文 792 paragraphs）
2. WBS
   - `WBS.xlsx`（9シート）
   - `QAチェック_V8`
   - `必須要件トレーサビリティ`
   - `必須逸脱一覧_承認用`
   - `WBS_V8`
   - `Sprint計画_V8`
   - `要件9章_MVP方針`
   - `Jira導入ガイド`
   - `技術スタック`
3. DB設計書
   - `DB設計書.xlsx`（12シート）
4. 技術設計書
   - `技術設計書.xlsx`（12シート）
5. 実施順序マップ
   - `実行順序ガイド.docx`
6. メイン統一手順書
   - `メイン統一手順書.xlsx`（10シート）
   - `Index, Prepare, Supabase, Azure_DI_Redis, CI_CD, Coding, DB, Verify, Recurring_Ops, Glossary`
7. その他補助資料群
   - `本番環境構築手順.xlsx`
   - `クリーンアップ・ロールバック.xlsx`
   - `トラブルシュート.xlsx`
   - `シークレットキー管理台帳.xlsx`
   - `コスト試算.xlsx`
   - `コピペ用テンプレート集.xlsx`
   - `サンプル手順・Copy_OK_List.xlsx`
   - `アーキテクチャ図5種.docx`

注記: `ai-accounting-os.zip` はモック資産として確認し、現行実装との差分検討では「参照元（再利用候補）」として扱う。

---

## 2. 要件・WBS観点の現状判定（S0→S1直前）

### 2.1 判定

- 結論: **S0完了、S1未着手〜ごく初期**。
- 理由:
  - WBSのS1（共通基盤）に含まれる認証・RBAC・RLS適用・API基盤・監査ログ・SEC/BK/監視文書が、現行リポジトリでは未実装または最小雛形に留まる。
  - 一方で、S0成果物に相当する設計資料群（要件、WBS、DB、技術、手順）が揃っている。

### 2.2 現行リポジトリ照合（主要）

- Next.js 15 + React 19 + Tailwind 4 の土台は存在。
- 画面はトップページ最小表示のみ。
- API Route Handlers（`/api/v1/*`）未作成。
- Supabase client/server helper はあるが、認証フロー、MFA、OAuth、RBACは未実装。
- `supabase/seed.sql` はマスタ投入SQLあり（DB-007相当の一部）が、migration群・RLS SQL・運用DDLの管理が不足。
- Worker/Queue 実体（BullMQ consumer、enqueueルート、ジョブ定義）が未実装。

---

## 3. ギャップ一覧（S1開始前）

### 3.1 共通基盤（WBS 2.1.x）

- 未実装:
  - ログイン/ログアウト/セッション管理UI
  - MFA登録・検証UI
  - Google OAuth導線
  - RBAC（admin/accounting/viewer）
  - tenant context を前提にしたアクセス制御導線
  - ユーザー管理CRUD（管理者限定）

### 3.2 FE基盤（WBS 2.2.x）

- 未実装:
  - Dashboard layout（サイドバー/ヘッダー）
  - 共通UI（テーブル、フォーム、モーダル、通知、検索）
  - モック移植方針に基づく画面骨格

### 3.3 API/データ基盤（WBS 2.3.x）

- 未実装:
  - `/api/v1` 配下エンドポイント群
  - Zodバリデーション、標準エラー形式統一
  - アップロードAPI（Storage + SHA-256 + 上限）
  - 監査ログ永続化導線
- 部分実装:
  - Supabase接続ユーティリティのみ

### 3.4 運用・セキュリティ文書（WBS 2.4.x）

- 未作成または不足:
  - SEC-001〜005 マッピング文書
  - バックアップ/リストア運用手順（実運用版）
  - 監視項目・通知設計（Vercel/Supabase/Azure）

### 3.5 DB運用

- 進捗:
  - ユーザー申告どおり「メイン統一手順書のDBシートまで」完了想定。
  - `seed.sql` が存在し、マスタ初期投入の足場あり。
- ギャップ:
  - `supabase/migrations/` の体系化不足（DDL/RLS/Index/Policy分離管理）
  - DB設計書の全25テーブル・RLS・監査要件との完全一致検証が未記録

---

## 4. S1開始のための「これからの手順」

以下は、WBS S1（2.1〜2.4）をそのまま実行可能な形に落とした**実施順序**。

## 4.1 Day 0（着手前チェック: 0.5日）

1. ブランチ作成 (`feature/s1-foundation`)。
2. DB実体確認（25テーブル・RLS・seed投入状態）。
3. `.env.local` とキー管理台帳の整合確認（漏洩対策）。
4. 4-point check の現状ベースライン取得（lint/typecheck/test/build）。

**完了条件**: 「今の失敗/不足」を固定化し、S1作業で増減を管理できる状態。

## 4.2 S1-1 認証・認可（WBS 2.1.x）

1. 認証ページ実装（login/signup/logout + セッションガード）。
2. MFA導線（登録・challenge）実装。
3. OAuthボタン導線（Google）実装。
4. RBACロール判定ユーティリティ実装。
5. `tenant_users` / `profiles` を用いたユーザー管理画面（admin限定）実装。

**DoD**
- admin/accounting/viewer で画面/操作制御が再現される。
- MFA有効ユーザーのログインが通る。

## 4.3 S1-2 FE基盤（WBS 2.2.x）

1. `(dashboard)` ルートグループ新設。
2. 共通Layout（Sidebar/Header/Breadcrumb）導入。
3. 共通UI部品（Table/Form/Modal/Toast/Search）整備。
4. 最低3画面（Dashboard, Documents, Users）の空実装。

**DoD**
- 認証後にdashboard layoutへ遷移。
- 全画面が共通レイアウト上で表示。

## 4.4 S1-3 API/監査基盤（WBS 2.3.x）

1. `/api/v1/health` を基準に API共通層を定義。
2. Zod + 共通エラーレスポンス `{ error: { code, message, details } }` を統一。
3. `documents/upload` 実装（サイズ制限、SHA-256、Storage保存、メタDB登録）。
4. `audit_logs` INSERT専用導線を共通化（成功/失敗とも記録）。

**DoD**
- 最低1本のPOST APIでバリデーション・監査ログ・エラー形式が一貫。

## 4.5 S1-4 セキュリティ/運用文書（WBS 2.4.x）

1. SEC-001〜005対応表を `docs/` に作成。
2. バックアップ/リストア手順（STG）を `docs/` に作成。
3. 監視設計（Vercel/Supabase/Azure DI/Redis/Worker）を `docs/` に作成。

**DoD**
- 手順書だけで第三者が同じ確認を再現可能。

## 4.6 S1ゲート（完了判定）

- 4-point check 全通過（lint → typecheck → test → build）。
- 主要機能デモ:
  - ログイン（MFA含む）
  - ロール差分表示
  - ドキュメント1件アップロード
  - 監査ログ1件以上確認
- `git diff --stat` で差分レビュー完了。

---

## 5. 直近の優先度（次の3アクション）

1. **API規約の先行固定**（共通エラー形式・Zod・監査ログフック）。
2. **認証/認可を最優先**（S1の他タスクの前提）。
3. **Docs先行**（SEC/BK/監視）を並行で進め、実装と乖離しないよう毎PRで更新。

---

## 6. 補足（S2以降の見取り図）

- S2: 証憑取込・仕訳提案・CSV取込の業務コア。
- S3: 決裁ワークフロー。
- S4: 管理会計/分析。
- S5: 外部連携・運用強化。

S1の品質が後続の速度を決めるため、S1は「機能数」より「共通基盤の一貫性」を優先する。
