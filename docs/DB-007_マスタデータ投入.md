# DB-007 マスタデータ投入

| 項目 | 内容 |
|------|------|
| **StepID** | DB-007 |
| **Phase** | DB |
| **Type** | DO |
| **前提** | DB-001〜DB-006 完了済み（テーブル作成・RLS適用・moddatetimeトリガー設定済み） |
| **参照元** | DB設計書 06_マスタデータ / 07_Seed / メイン統一手順書 DB-007 |
| **ArtifactRef** | A-DB-SEED |
| **作成日** | 2026-02-17 |

---

## 1. 概要

本手順は、AI Business Accounting OS の**マスタテーブル（`m_*`）および初期テナント設定**への初期データ投入を行う。

### 1.1 投入対象テーブル

| # | テーブル | 用途 | PK | 投入件数 |
|---|---------|------|-----|---------|
| 1 | `m_document_types` | 証憑種別コード | `code` (text) | 7件 |
| 2 | `m_tax_codes` | 税区分コード（課税10%/8%/非課税/免税） | `code` (text) | 4件 |
| 3 | `m_approval_types` | 決裁種別コード | `code` (text) | 4件 |
| 4 | `m_accounts` | 勘定科目マスタ（テナント別） | `(tenant_id, code)` 複合PK | 35件/テナント |
| 5 | `tenants` | テナント（企業）マスタ ※開発用 | `id` (uuid) | 1件 |
| 6 | `tenant_settings` | テナント設定（閾値/コスト上限） | `tenant_id` (uuid) | 1件 |

### 1.2 投入順序（FK依存）

```
m_document_types  ─┐
m_tax_codes       ─┤  ※ FK依存なし（独立マスタ）
m_approval_types  ─┘
        │
        ▼
    tenants           ← 他テーブルの FK 参照先
        │
        ├─► tenant_settings  (tenant_id → tenants.id)
        └─► m_accounts       (tenant_id → tenants.id)
```

> **重要**: `m_accounts` は `tenants` への FK を持つため、必ず `tenants` の INSERT 後に実行すること。

---

## 2. マスタデータ定義

### 2.1 m_document_types — 証憑種別コード

アプリ内で証憑（documents テーブル）の `document_type` カラムが FK 参照する。

| code | name | 説明 |
|------|------|------|
| `invoice` | 請求書 | 発行・受領請求書 |
| `receipt` | 領収書 | 支払証明 |
| `quotation` | 見積書 | 見積書類 |
| `contract` | 契約書 | 業務委託・売買契約等 |
| `bank_statement` | 銀行明細 | 銀行取引明細CSV/PDF |
| `credit_card` | クレカ明細 | クレジットカード利用明細 |
| `other` | その他 | 上記に該当しない証憑 |

**テーブル定義**:

| カラム | 型 | 制約 | 説明 |
|--------|------|------|------|
| `code` | text | PK, NOT NULL | 証憑種別コード |
| `name` | text | NOT NULL | 表示名 |
| `created_at` | timestamptz | NOT NULL, DEFAULT now() | 作成日時 |

**RLSポリシー**: SELECT = `public_read`（認証済み全ユーザー参照可）/ INSERT・UPDATE・DELETE = `service_only`（service_role のみ）

---

### 2.2 m_tax_codes — 税区分コード

インボイス制度対応の税区分マスタ。`journal_lines.tax_code` および `invoice_lines.tax_code` が FK 参照する。

| code | name | tax_rate | is_taxable | 説明 |
|------|------|---------|------------|------|
| `TAX10` | 課税10% | 10.00 | true | 標準税率（消費税10%） |
| `TAX8` | 課税8%（軽減） | 8.00 | true | 軽減税率（食品・新聞等） |
| `NONTAX` | 非課税 | 0.00 | false | 非課税取引（保険料・利子等） |
| `EXEMPT` | 免税 | 0.00 | false | 輸出免税等 |

**テーブル定義**:

| カラム | 型 | 制約 | 説明 |
|--------|------|------|------|
| `code` | text | PK, NOT NULL | 税区分コード |
| `name` | text | NOT NULL | 表示名 |
| `tax_rate` | numeric(5,2) | NULL可 | 税率（%） |
| `is_taxable` | boolean | NOT NULL, DEFAULT true | 課税区分フラグ |
| `created_at` | timestamptz | NOT NULL, DEFAULT now() | 作成日時 |

**RLSポリシー**: SELECT = `public_read` / INSERT・UPDATE・DELETE = `service_only`

> **補足（インボイス制度）**: 適格請求書には「適用税率」と「税率ごとの消費税額」の記載が必須（消費税法第57条の4）。本マスタの `tax_rate` を基に、請求書明細（`invoice_lines`）および仕訳明細（`journal_lines`）で税区分を管理する。

---

### 2.3 m_approval_types — 決裁種別コード

決裁申請（`approvals` テーブル）の `approval_type` カラムが FK 参照する。

| code | name | 説明 |
|------|------|------|
| `payment` | 支払申請 | 取引先への支払承認 |
| `expense` | 経費申請 | 経費精算 |
| `reimbursement` | 立替精算 | 社員立替費用の精算 |
| `partner_change` | 取引先登録/変更申請 | 取引先マスタの新規登録・変更承認 |

**テーブル定義**:

| カラム | 型 | 制約 | 説明 |
|--------|------|------|------|
| `code` | text | PK, NOT NULL | 決裁種別コード |
| `name` | text | NOT NULL | 表示名 |
| `created_at` | timestamptz | NOT NULL, DEFAULT now() | 作成日時 |

**RLSポリシー**: SELECT = `public_read` / INSERT・UPDATE・DELETE = `service_only`

---

### 2.4 m_accounts — 勘定科目マスタ（テナント別）

テナントごとに保持する勘定科目体系。`journal_lines` の `(tenant_id, account_code)` が複合 FK で参照する。

**テーブル定義**:

| カラム | 型 | 制約 | 説明 |
|--------|------|------|------|
| `tenant_id` | uuid | PK (複合), NOT NULL, FK → tenants(id) | テナントID |
| `code` | text | PK (複合), NOT NULL | 勘定科目コード |
| `name` | text | NOT NULL | 科目名 |
| `category` | text | NOT NULL | 分類: asset/liability/equity/revenue/expense |
| `parent_code` | text | NULL可, FK → m_accounts(tenant_id, code) | 親科目（階層構造用） |
| `is_active` | boolean | NOT NULL, DEFAULT true | 有効フラグ |
| `created_at` | timestamptz | NOT NULL, DEFAULT now() | 作成日時 |
| `updated_at` | timestamptz | NOT NULL, DEFAULT now() | 更新日時（moddatetimeトリガー） |

**RLSポリシー**: SELECT・INSERT・UPDATE・DELETE = `tenant_members`（is_tenant_member関数によるテナント分離）

**開発テナント用 初期科目一覧（35件）**:

#### 資産（asset）— 11科目

| code | name | parent_code | 説明 |
|------|------|-------------|------|
| `1100` | 現金 | — | 手許現金 |
| `1110` | 普通預金 | — | 銀行普通預金 |
| `1120` | 当座預金 | — | 銀行当座預金 |
| `1200` | 売掛金 | — | 売上債権 |
| `1300` | 未収入金 | — | 営業外の未収金 |
| `1400` | 前払費用 | — | 前払い分の費用 |
| `1500` | 仮払金 | — | 精算前の仮払い |
| `1600` | 立替金 | — | 第三者のために立替えた金額 |
| `1710` | 仮払消費税 | — | 仕入税額控除対象の仮払消費税 |
| `1800` | 固定資産 | — | 有形固定資産（親科目） |
| `1810` | 工具器具備品 | `1800` | 固定資産の子科目 |

#### 負債（liability）— 7科目

| code | name | parent_code | 説明 |
|------|------|-------------|------|
| `2100` | 買掛金 | — | 仕入債務 |
| `2200` | 未払金 | — | 営業外の未払い |
| `2300` | 未払費用 | — | 発生済み未払の費用 |
| `2400` | 前受金 | — | 受領済み未計上の売上 |
| `2500` | 預り金 | — | 源泉徴収税等の預り |
| `2600` | 仮受消費税 | — | 売上に係る仮受消費税 |
| `2700` | 短期借入金 | — | 1年以内返済の借入 |

#### 純資産（equity）— 2科目

| code | name | parent_code | 説明 |
|------|------|-------------|------|
| `3100` | 資本金 | — | 出資金 |
| `3200` | 利益剰余金 | — | 繰越利益剰余金 |

#### 収益（revenue）— 3科目

| code | name | parent_code | 説明 |
|------|------|-------------|------|
| `4100` | 売上高 | — | 本業の売上 |
| `4200` | 受取手数料 | — | 営業外の手数料収入 |
| `4300` | 雑収入 | — | その他の収入 |

#### 費用（expense）— 12科目

| code | name | parent_code | 説明 |
|------|------|-------------|------|
| `5100` | 仕入高 | — | 商品・原材料の仕入 |
| `5200` | 外注費 | — | 業務委託費 |
| `5300` | 給与手当 | — | 従業員給与 |
| `5400` | 法定福利費 | — | 社会保険料の事業主負担分 |
| `5500` | 通信費 | — | 電話・インターネット等 |
| `5600` | 旅費交通費 | — | 出張・通勤交通費 |
| `5700` | 広告宣伝費 | — | 広告・PR費用 |
| `5800` | 消耗品費 | — | 事務用品等の消耗品 |
| `5900` | 接待交際費 | — | 取引先接待・贈答等 |
| `6100` | 減価償却費 | — | 固定資産の償却費 |
| `6200` | 支払手数料 | — | 振込手数料等 |
| `6300` | 雑損失 | — | その他の損失 |

> **本番運用時の注意**: 上記は開発テナント（`00000000-0000-0000-0000-000000000001`）用の初期科目体系である。本番テナントでは、テナント初期設定フロー（サインアップ時）で業種に応じた科目テンプレートを自動投入する設計とする。

---

### 2.5 tenants — 開発用テナント

| id | name | plan | status |
|----|------|------|--------|
| `00000000-0000-0000-0000-000000000001` | 開発用テナント | free | active |

> **注意**: 本番環境では管理画面またはサインアップフローでテナントを作成する。Seed で作成するのは**開発・テスト専用**。

---

### 2.6 tenant_settings — テナント設定（デフォルト値）

| tenant_id | auto_confirm_high | auto_confirm_mid | ai_daily_cost_limit_jpy |
|-----------|-------------------|------------------|------------------------|
| `00000000-...-000000000001` | 0.90 | 0.70 | 0（無制限） |

**設定値の意味**:

| 設定項目 | 値 | 説明 | 関連要件 |
|---------|------|------|---------|
| `auto_confirm_high` | 0.90 | AI信頼度≧0.90 → 自動確定 | CMN-012 |
| `auto_confirm_mid` | 0.70 | AI信頼度 0.70〜0.90 → ユーザー確認要 | CMN-012 |
| `ai_daily_cost_limit_jpy` | 0 | AI API日次コスト上限（0=無制限） | コスト管理 |

---

## 3. 実行手順

### 3.1 実行環境

| 環境 | 実行方法 |
|------|---------|
| **ローカル開発** | `supabase db reset`（seed.sql を自動実行） |
| **Supabase Dashboard** | SQL Editor → New query → 下記SQLを貼り付けて実行 |
| **Supabase CLI** | `supabase db push` でマイグレーション適用後、SQL Editor で Seed を実行 |

### 3.2 Seed SQL（完全版）

以下のSQLをそのまま Supabase SQL Editor に貼り付けて実行、または `supabase/seed.sql` として保存する。

```sql
-- ============================================
-- Seed SQL: AI Business Accounting OS
-- 対象: マスタテーブル + 初期テナント設定
-- 実行順序: マスタ → テナント → 設定 → 勘定科目
-- 冪等性: ON CONFLICT DO NOTHING で再実行安全
-- ============================================

-- ============================================
-- 1. 証憑種別マスタ (m_document_types)
-- ============================================
-- documents.document_type が FK 参照
-- 7種別: 請求書/領収書/見積書/契約書/銀行明細/クレカ明細/その他

INSERT INTO public.m_document_types (code, name) VALUES
  ('invoice',        '請求書'),
  ('receipt',        '領収書'),
  ('quotation',      '見積書'),
  ('contract',       '契約書'),
  ('bank_statement', '銀行明細'),
  ('credit_card',    'クレカ明細'),
  ('other',          'その他')
ON CONFLICT (code) DO NOTHING;

-- ============================================
-- 2. 税区分マスタ (m_tax_codes)
-- ============================================
-- journal_lines.tax_code / invoice_lines.tax_code が FK 参照
-- インボイス制度対応: 標準税率10% / 軽減税率8% / 非課税 / 免税

INSERT INTO public.m_tax_codes (code, name, tax_rate, is_taxable) VALUES
  ('TAX10',   '課税10%',        10.00, true),
  ('TAX8',    '課税8%（軽減）',   8.00, true),
  ('NONTAX',  '非課税',           0.00, false),
  ('EXEMPT',  '免税',             0.00, false)
ON CONFLICT (code) DO NOTHING;

-- ============================================
-- 3. 決裁種別マスタ (m_approval_types)
-- ============================================
-- approvals.approval_type が FK 参照
-- 4種別: 支払申請/経費申請/立替精算/取引先登録変更

INSERT INTO public.m_approval_types (code, name) VALUES
  ('payment',        '支払申請'),
  ('expense',        '経費申請'),
  ('reimbursement',  '立替精算'),
  ('partner_change', '取引先登録/変更申請')
ON CONFLICT (code) DO NOTHING;

-- ============================================
-- 4. 初期テナント（開発/テスト用）
-- ============================================
-- ※ 本番では管理画面またはサインアップフローで作成
-- ※ 固定UUID: 開発環境での参照安定性のため

INSERT INTO public.tenants (id, name, plan, status) VALUES
  ('00000000-0000-0000-0000-000000000001', '開発用テナント', 'free', 'active')
ON CONFLICT (id) DO NOTHING;

-- ============================================
-- 5. テナント設定（デフォルト値）
-- ============================================
-- CMN-012: AI信頼度閾値による自動確定制御
--   ≧ 0.90 → 自動確定
--   0.70〜0.90 → ユーザー確認要
--   < 0.70 → 保留（要レビュー）

INSERT INTO public.tenant_settings (
  tenant_id,
  auto_confirm_high,
  auto_confirm_mid,
  ai_daily_cost_limit_jpy
) VALUES (
  '00000000-0000-0000-0000-000000000001',
  0.90,    -- 高信頼度閾値
  0.70,    -- 中信頼度閾値
  0        -- AI日次コスト上限（0=無制限）
)
ON CONFLICT (tenant_id) DO NOTHING;

-- ============================================
-- 6. 勘定科目マスタ（開発テナント用）
-- ============================================
-- ※ 本番ではテナント初期設定フローで業種別テンプレートから投入
-- ※ 中小企業向け標準科目体系（35科目）
-- ※ parent_code による階層構造対応（例: 1810→1800）

INSERT INTO public.m_accounts (
  tenant_id, code, name, category, parent_code, is_active
) VALUES
  -- ========== 資産 (asset) ==========
  ('00000000-0000-0000-0000-000000000001', '1100', '現金',         'asset',     NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '1110', '普通預金',     'asset',     NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '1120', '当座預金',     'asset',     NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '1200', '売掛金',       'asset',     NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '1300', '未収入金',     'asset',     NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '1400', '前払費用',     'asset',     NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '1500', '仮払金',       'asset',     NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '1600', '立替金',       'asset',     NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '1710', '仮払消費税',   'asset',     NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '1800', '固定資産',     'asset',     NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '1810', '工具器具備品', 'asset',     '1800', true),

  -- ========== 負債 (liability) ==========
  ('00000000-0000-0000-0000-000000000001', '2100', '買掛金',       'liability', NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '2200', '未払金',       'liability', NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '2300', '未払費用',     'liability', NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '2400', '前受金',       'liability', NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '2500', '預り金',       'liability', NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '2600', '仮受消費税',   'liability', NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '2700', '短期借入金',   'liability', NULL,   true),

  -- ========== 純資産 (equity) ==========
  ('00000000-0000-0000-0000-000000000001', '3100', '資本金',       'equity',    NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '3200', '利益剰余金',   'equity',    NULL,   true),

  -- ========== 収益 (revenue) ==========
  ('00000000-0000-0000-0000-000000000001', '4100', '売上高',       'revenue',   NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '4200', '受取手数料',   'revenue',   NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '4300', '雑収入',       'revenue',   NULL,   true),

  -- ========== 費用 (expense) ==========
  ('00000000-0000-0000-0000-000000000001', '5100', '仕入高',       'expense',   NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '5200', '外注費',       'expense',   NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '5300', '給与手当',     'expense',   NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '5400', '法定福利費',   'expense',   NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '5500', '通信費',       'expense',   NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '5600', '旅費交通費',   'expense',   NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '5700', '広告宣伝費',   'expense',   NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '5800', '消耗品費',     'expense',   NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '5900', '接待交際費',   'expense',   NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '6100', '減価償却費',   'expense',   NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '6200', '支払手数料',   'expense',   NULL,   true),
  ('00000000-0000-0000-0000-000000000001', '6300', '雑損失',       'expense',   NULL,   true)
ON CONFLICT (tenant_id, code) DO NOTHING;

-- ============================================
-- 完了確認
-- ============================================
SELECT 'Seed completed' AS result;
```

---

## 4. 確認手順（DB-008）

Seed SQL 実行後、以下のクエリで投入結果を検証する。

### 4.1 件数確認

```sql
-- 各マスタテーブルの件数を一括確認
SELECT 'm_document_types' AS table_name, count(*) AS row_count FROM public.m_document_types
UNION ALL
SELECT 'm_tax_codes',      count(*) FROM public.m_tax_codes
UNION ALL
SELECT 'm_approval_types', count(*) FROM public.m_approval_types
UNION ALL
SELECT 'm_accounts',       count(*) FROM public.m_accounts
UNION ALL
SELECT 'tenants',          count(*) FROM public.tenants
UNION ALL
SELECT 'tenant_settings',  count(*) FROM public.tenant_settings
ORDER BY table_name;
```

**期待結果**:

| table_name | row_count |
|-----------|-----------|
| m_accounts | 35 |
| m_approval_types | 4 |
| m_document_types | 7 |
| m_tax_codes | 4 |
| tenant_settings | 1 |
| tenants | 1 |

### 4.2 データ内容確認

```sql
-- 証憑種別
SELECT code, name FROM public.m_document_types ORDER BY code;

-- 税区分（税率・課税フラグ含む）
SELECT code, name, tax_rate, is_taxable FROM public.m_tax_codes ORDER BY code;

-- 決裁種別
SELECT code, name FROM public.m_approval_types ORDER BY code;

-- 勘定科目（カテゴリ別件数）
SELECT category, count(*) AS cnt
FROM public.m_accounts
WHERE tenant_id = '00000000-0000-0000-0000-000000000001'
GROUP BY category
ORDER BY category;

-- 勘定科目（全件）
SELECT code, name, category, parent_code, is_active
FROM public.m_accounts
WHERE tenant_id = '00000000-0000-0000-0000-000000000001'
ORDER BY code;

-- テナント
SELECT id, name, plan, status FROM public.tenants;

-- テナント設定
SELECT tenant_id, auto_confirm_high, auto_confirm_mid, ai_daily_cost_limit_jpy
FROM public.tenant_settings;
```

**勘定科目カテゴリ別件数の期待結果**:

| category | cnt |
|----------|-----|
| asset | 11 |
| equity | 2 |
| expense | 12 |
| liability | 7 |
| revenue | 3 |

### 4.3 FK参照整合性確認

```sql
-- m_accounts の tenant_id が tenants に存在するか
SELECT a.tenant_id, a.code, a.name
FROM public.m_accounts a
LEFT JOIN public.tenants t ON t.id = a.tenant_id
WHERE t.id IS NULL;
-- 期待: 0行（全て参照先が存在する）

-- m_accounts の parent_code 参照整合性
SELECT a.tenant_id, a.code, a.name, a.parent_code
FROM public.m_accounts a
WHERE a.parent_code IS NOT NULL
  AND NOT EXISTS (
    SELECT 1 FROM public.m_accounts p
    WHERE p.tenant_id = a.tenant_id AND p.code = a.parent_code
  );
-- 期待: 0行（parent_code が全て有効）

-- tenant_settings の tenant_id が tenants に存在するか
SELECT ts.tenant_id
FROM public.tenant_settings ts
LEFT JOIN public.tenants t ON t.id = ts.tenant_id
WHERE t.id IS NULL;
-- 期待: 0行
```

---

## 5. seed.sql ファイル配置

ローカル開発で `supabase db reset` を使用する場合、上記SQLを `supabase/seed.sql` に配置する。

### 5.1 ファイルパス

```
supabase/
  seed.sql          ← Seed SQL（本ドキュメントのSQLをそのまま配置）
  config.toml       ← db.seed.sql_paths = ["./seed.sql"] で参照
  migrations/
    YYYYMMDDHHMMSS_initial_schema.sql  ← DDL（DB-001）
```

### 5.2 config.toml の設定確認

```toml
[db.seed]
enabled = true
sql_paths = ["./seed.sql"]
```

### 5.3 ローカルでの実行

```bash
# マイグレーション + Seed を一括実行（DBリセット）
supabase db reset

# Seed のみ再実行したい場合は SQL Editor で直接実行
# ON CONFLICT DO NOTHING により再実行しても安全
```

---

## 6. 冪等性・安全性

### 6.1 ON CONFLICT DO NOTHING

全 INSERT 文に `ON CONFLICT ... DO NOTHING` を付与しているため、**何度実行しても安全**。既存データは上書きされない。

| テーブル | CONFLICT キー | 動作 |
|---------|-------------|------|
| `m_document_types` | `code` | 既存コードはスキップ |
| `m_tax_codes` | `code` | 既存コードはスキップ |
| `m_approval_types` | `code` | 既存コードはスキップ |
| `tenants` | `id` | 既存テナントはスキップ |
| `tenant_settings` | `tenant_id` | 既存設定はスキップ |
| `m_accounts` | `(tenant_id, code)` | 既存科目はスキップ |

### 6.2 既存データの更新が必要な場合

マスタデータの修正が必要な場合は、`ON CONFLICT DO NOTHING` ではなく `ON CONFLICT DO UPDATE` に変更するか、個別の `UPDATE` 文を使用する。

```sql
-- 例: 税区分の名称を更新する場合
UPDATE public.m_tax_codes
SET name = '課税10%（標準）'
WHERE code = 'TAX10';
```

> **注意**: マスタテーブルの INSERT/UPDATE/DELETE は RLS で `service_role` のみに制限されている。Supabase SQL Editor は `service_role` で実行されるため問題ないが、アプリケーションコードからの直接更新は不可。

---

## 7. 本番環境での運用

### 7.1 マスタデータの投入タイミング

| タイミング | 対象 | 方法 |
|-----------|------|------|
| **初回デプロイ時** | m_document_types / m_tax_codes / m_approval_types | マイグレーションとして適用 |
| **テナント作成時** | tenants / tenant_settings / m_accounts | サインアップフローまたは管理画面から自動投入 |
| **科目追加・税制改正時** | m_tax_codes / m_accounts | 管理者による SQL 実行またはマイグレーション |

### 7.2 マイグレーションとしての管理

本番環境では Seed SQL をマイグレーションファイルとして管理することを推奨する。

```bash
# マイグレーションファイルの作成
supabase migration new seed_master_data

# 作成されたファイルに Seed SQL を記述
# supabase/migrations/YYYYMMDDHHMMSS_seed_master_data.sql
```

### 7.3 税制改正への対応

インボイス制度の税率変更・新税区分追加が発生した場合は、以下の手順で対応する。

1. **m_tax_codes に新コードを INSERT**（既存コードは変更しない）
2. **アプリケーション側のデフォルト値を更新**
3. **既存仕訳データはそのまま保持**（遡及変更しない）

```sql
-- 例: 将来の税率変更時
INSERT INTO public.m_tax_codes (code, name, tax_rate, is_taxable) VALUES
  ('TAX12', '課税12%', 12.00, true)
ON CONFLICT (code) DO NOTHING;
```

### 7.4 テナント別科目テンプレート

本番運用では、テナント作成時に業種別の科目テンプレートから `m_accounts` を自動投入する。

```sql
-- 例: 新規テナント作成時の科目投入（サービス業テンプレート）
INSERT INTO public.m_accounts (tenant_id, code, name, category, parent_code, is_active)
SELECT
  :new_tenant_id,   -- 新規テナントID
  code, name, category, parent_code, is_active
FROM public.m_accounts
WHERE tenant_id = '00000000-0000-0000-0000-000000000001'  -- テンプレートテナントからコピー
ON CONFLICT (tenant_id, code) DO NOTHING;
```

---

## 8. トラブルシューティング

### 8.1 FK違反エラー

```
ERROR: insert or update on table "m_accounts" violates foreign key constraint
```

**原因**: `tenants` テーブルに `00000000-0000-0000-0000-000000000001` が存在しない。

**対処**: Seed SQL の実行順序を確認。tenants の INSERT が m_accounts より先に実行されているか確認する。

### 8.2 RLS違反エラー

```
ERROR: new row violates row-level security policy
```

**原因**: RLS が有効な状態で、権限のないロールから INSERT を実行している。

**対処**:
- Supabase SQL Editor（service_role）から実行する
- または `SET ROLE service_role;` を先頭に追加する

### 8.3 重複実行時の挙動

`ON CONFLICT DO NOTHING` により、重複実行してもエラーにはならない。ただし、**既存データは更新されない**。意図的にデータを更新したい場合は個別の `UPDATE` 文を使用する。

### 8.4 parent_code 参照エラー（m_accounts）

```
ERROR: insert or update on table "m_accounts" violates foreign key constraint "m_accounts_tenant_id_parent_code_fkey"
```

**原因**: `parent_code` で参照している親科目がまだ INSERT されていない。

**対処**: 親科目（`parent_code IS NULL`）が先に INSERT されるよう、SQL の行順序を確認する。本 Seed SQL では `1800`（固定資産）→ `1810`（工具器具備品）の順序で定義済み。

---

## 9. 関連ドキュメント

| ドキュメント | 参照先 | 内容 |
|------------|--------|------|
| DB設計書 06_マスタデータ | `Claude_Code_Document/DB設計書.xlsx` シート06 | コード表の定義 |
| DB設計書 07_Seed | `Claude_Code_Document/DB設計書.xlsx` シート07 | 初期投入SQL |
| DB設計書 03_テーブル定義 | `Claude_Code_Document/DB設計書.xlsx` シート03 | カラム定義詳細 |
| DB設計書 04_RLSポリシー | `Claude_Code_Document/DB設計書.xlsx` シート04 | マスタテーブルのRLS設計 |
| 要件定義書 | `Claude_Code_Document/要件定義書.docx` | CMN-012（閾値設定）等 |
| メイン統一手順書 DB | `Claude_Code_Document/メイン統一手順書.xlsx` シートDB | 全DB手順の流れ |

---

## 10. チェックリスト

実行完了後、以下を確認して DB-007 を完了とする。

- [ ] Seed SQL を Supabase SQL Editor で実行（またはローカルで `supabase db reset`）
- [ ] `m_document_types` に 7件投入されている
- [ ] `m_tax_codes` に 4件投入されている（TAX10 / TAX8 / NONTAX / EXEMPT）
- [ ] `m_approval_types` に 4件投入されている
- [ ] `tenants` に開発用テナント（`00000000-...-000000000001`）が存在する
- [ ] `tenant_settings` にデフォルト値が設定されている（0.90 / 0.70 / 0）
- [ ] `m_accounts` に 35件の勘定科目が投入されている（asset:11 / liability:7 / equity:2 / revenue:3 / expense:12）
- [ ] FK参照整合性チェック（セクション4.3）でエラー行が 0件
- [ ] `supabase/seed.sql` にSQLファイルが配置されている（ローカル開発用）

---

> **次ステップ**: DB-008（マスタデータ確認）→ DB-009（パフォーマンスインデックス作成）へ進む。
